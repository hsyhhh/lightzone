#define LZDEBUG
#ifndef PAGE_SIZE
#define PAGE_SIZE 4096
#endif

#include <liblz.h>
#include <stdio.h>

#define arch_counter_enforce_ordering(val) do {				\
	unsigned long tmp, _val = (val);						\
									\
	asm volatile(							\
	"	eor	%0, %1, %1\n"					\
	"	add	%0, sp, %0\n"					\
	"	ldr	xzr, [%0]"					\
	: "=r" (tmp) : "r" (_val));					\
} while (0)

#define ARMV8_PMCR_LC		(1UL << 6)
#define ARMV8_PMCR_E		(1UL << 0)

void activate_counter(void)
{
	asm volatile("msr pmcr_el0, %0\n\t"
				 "nop\n" :: "r" (ARMV8_PMCR_LC | ARMV8_PMCR_E) : "memory");
}

unsigned long pmcr_el0(void)
{
	unsigned long cnt;

	asm volatile("isb\n mrs %0, pmcr_el0\n"
				 "nop\n"
		     : "=r" (cnt));
	arch_counter_enforce_ordering(cnt);
	return cnt;
}

unsigned long pmcntenset_el0(void)
{
	unsigned long cnt;

	asm volatile("isb\n mrs %0, pmcntenset_el0\n"
				 "nop\n"
		     : "=r" (cnt));
	arch_counter_enforce_ordering(cnt);
	return cnt;
}

unsigned long pmuserenr_el0(void)
{
	unsigned long cnt;

	asm volatile("isb\n mrs %0, pmuserenr_el0\n"
				 "nop\n"
		     : "=r" (cnt));
	arch_counter_enforce_ordering(cnt);
	return cnt;
}

unsigned long ccnt_read(void)
{
	unsigned long cnt;

	asm volatile("isb\n mrs %0, pmccntr_el0\n"
				 "nop\n"
		     : "=r" (cnt));
	arch_counter_enforce_ordering(cnt);
	return cnt;
}

int main() {
    int iter = 10000;
	int *page_1 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_2 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_3 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_4 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_5 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_6 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_7 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_8 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_9 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_10 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_11 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_12 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_13 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_14 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_15 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_16 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_17 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_18 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_19 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_20 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_21 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_22 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_23 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_24 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_25 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_26 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_27 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_28 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_29 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_30 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_31 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_32 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_33 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_34 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_35 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_36 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_37 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_38 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_39 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_40 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_41 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_42 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_43 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_44 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_45 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_46 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_47 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_48 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_49 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_50 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_51 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_52 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_53 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_54 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_55 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_56 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_57 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_58 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_59 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_60 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_61 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_62 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_63 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_64 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_65 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_66 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_67 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_68 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_69 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_70 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_71 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_72 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_73 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_74 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_75 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_76 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_77 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_78 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_79 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_80 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_81 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_82 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_83 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_84 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_85 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_86 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_87 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_88 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_89 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_90 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_91 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_92 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_93 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_94 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_95 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_96 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_97 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_98 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_99 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_100 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_101 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_102 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_103 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_104 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_105 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_106 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_107 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_108 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_109 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_110 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_111 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_112 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_113 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_114 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_115 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_116 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_117 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_118 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_119 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_120 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_121 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_122 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_123 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_124 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_125 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_126 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_127 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);
	int *page_128 = (int *)memalign(PAGE_SIZE, PAGE_SIZE);

    unsigned long start, end, baseline;

	int i;

	for(i = 0; i < PAGE_SIZE / sizeof(int); i++) {
		page_1[i] = i + 1;
		page_2[i] = i + 2;
		page_3[i] = i + 3;
		page_4[i] = i + 4;
		page_5[i] = i + 5;
		page_6[i] = i + 6;
		page_7[i] = i + 7;
		page_8[i] = i + 8;
		page_9[i] = i + 9;
		page_10[i] = i + 10;
		page_11[i] = i + 11;
		page_12[i] = i + 12;
		page_13[i] = i + 13;
		page_14[i] = i + 14;
		page_15[i] = i + 15;
		page_16[i] = i + 16;
		page_17[i] = i + 17;
		page_18[i] = i + 18;
		page_19[i] = i + 19;
		page_20[i] = i + 20;
		page_21[i] = i + 21;
		page_22[i] = i + 22;
		page_23[i] = i + 23;
		page_24[i] = i + 24;
		page_25[i] = i + 25;
		page_26[i] = i + 26;
		page_27[i] = i + 27;
		page_28[i] = i + 28;
		page_29[i] = i + 29;
		page_30[i] = i + 30;
		page_31[i] = i + 31;
		page_32[i] = i + 32;
		page_33[i] = i + 33;
		page_34[i] = i + 34;
		page_35[i] = i + 35;
		page_36[i] = i + 36;
		page_37[i] = i + 37;
		page_38[i] = i + 38;
		page_39[i] = i + 39;
		page_40[i] = i + 40;
		page_41[i] = i + 41;
		page_42[i] = i + 42;
		page_43[i] = i + 43;
		page_44[i] = i + 44;
		page_45[i] = i + 45;
		page_46[i] = i + 46;
		page_47[i] = i + 47;
		page_48[i] = i + 48;
		page_49[i] = i + 49;
		page_50[i] = i + 50;
		page_51[i] = i + 51;
		page_52[i] = i + 52;
		page_53[i] = i + 53;
		page_54[i] = i + 54;
		page_55[i] = i + 55;
		page_56[i] = i + 56;
		page_57[i] = i + 57;
		page_58[i] = i + 58;
		page_59[i] = i + 59;
		page_60[i] = i + 60;
		page_61[i] = i + 61;
		page_62[i] = i + 62;
		page_63[i] = i + 63;
		page_64[i] = i + 64;
		page_65[i] = i + 65;
		page_66[i] = i + 66;
		page_67[i] = i + 67;
		page_68[i] = i + 68;
		page_69[i] = i + 69;
		page_70[i] = i + 70;
		page_71[i] = i + 71;
		page_72[i] = i + 72;
		page_73[i] = i + 73;
		page_74[i] = i + 74;
		page_75[i] = i + 75;
		page_76[i] = i + 76;
		page_77[i] = i + 77;
		page_78[i] = i + 78;
		page_79[i] = i + 79;
		page_80[i] = i + 80;
		page_81[i] = i + 81;
		page_82[i] = i + 82;
		page_83[i] = i + 83;
		page_84[i] = i + 84;
		page_85[i] = i + 85;
		page_86[i] = i + 86;
		page_87[i] = i + 87;
		page_88[i] = i + 88;
		page_89[i] = i + 89;
		page_90[i] = i + 90;
		page_91[i] = i + 91;
		page_92[i] = i + 92;
		page_93[i] = i + 93;
		page_94[i] = i + 94;
		page_95[i] = i + 95;
		page_96[i] = i + 96;
		page_97[i] = i + 97;
		page_98[i] = i + 98;
		page_99[i] = i + 99;
		page_100[i] = i + 100;
		page_101[i] = i + 101;
		page_102[i] = i + 102;
		page_103[i] = i + 103;
		page_104[i] = i + 104;
		page_105[i] = i + 105;
		page_106[i] = i + 106;
		page_107[i] = i + 107;
		page_108[i] = i + 108;
		page_109[i] = i + 109;
		page_110[i] = i + 110;
		page_111[i] = i + 111;
		page_112[i] = i + 112;
		page_113[i] = i + 113;
		page_114[i] = i + 114;
		page_115[i] = i + 115;
		page_116[i] = i + 116;
		page_117[i] = i + 117;
		page_118[i] = i + 118;
		page_119[i] = i + 119;
		page_120[i] = i + 120;
		page_121[i] = i + 121;
		page_122[i] = i + 122;
		page_123[i] = i + 123;
		page_124[i] = i + 124;
		page_125[i] = i + 125;
		page_126[i] = i + 126;
		page_127[i] = i + 127;
		page_128[i] = i + 128;

	}

	printf("The page 1 is %lx\n", (unsigned long)page_1);
	printf("The page 2 is %lx\n", (unsigned long)page_2);
	printf("The page 3 is %lx\n", (unsigned long)page_3);
	printf("The page 4 is %lx\n", (unsigned long)page_4);
	printf("The page 5 is %lx\n", (unsigned long)page_5);
	printf("The page 6 is %lx\n", (unsigned long)page_6);
	printf("The page 7 is %lx\n", (unsigned long)page_7);
	printf("The page 8 is %lx\n", (unsigned long)page_8);
	printf("The page 9 is %lx\n", (unsigned long)page_9);
	printf("The page 10 is %lx\n", (unsigned long)page_10);
	printf("The page 11 is %lx\n", (unsigned long)page_11);
	printf("The page 12 is %lx\n", (unsigned long)page_12);
	printf("The page 13 is %lx\n", (unsigned long)page_13);
	printf("The page 14 is %lx\n", (unsigned long)page_14);
	printf("The page 15 is %lx\n", (unsigned long)page_15);
	printf("The page 16 is %lx\n", (unsigned long)page_16);
	printf("The page 17 is %lx\n", (unsigned long)page_17);
	printf("The page 18 is %lx\n", (unsigned long)page_18);
	printf("The page 19 is %lx\n", (unsigned long)page_19);
	printf("The page 20 is %lx\n", (unsigned long)page_20);
	printf("The page 21 is %lx\n", (unsigned long)page_21);
	printf("The page 22 is %lx\n", (unsigned long)page_22);
	printf("The page 23 is %lx\n", (unsigned long)page_23);
	printf("The page 24 is %lx\n", (unsigned long)page_24);
	printf("The page 25 is %lx\n", (unsigned long)page_25);
	printf("The page 26 is %lx\n", (unsigned long)page_26);
	printf("The page 27 is %lx\n", (unsigned long)page_27);
	printf("The page 28 is %lx\n", (unsigned long)page_28);
	printf("The page 29 is %lx\n", (unsigned long)page_29);
	printf("The page 30 is %lx\n", (unsigned long)page_30);
	printf("The page 31 is %lx\n", (unsigned long)page_31);
	printf("The page 32 is %lx\n", (unsigned long)page_32);
	printf("The page 33 is %lx\n", (unsigned long)page_33);
	printf("The page 34 is %lx\n", (unsigned long)page_34);
	printf("The page 35 is %lx\n", (unsigned long)page_35);
	printf("The page 36 is %lx\n", (unsigned long)page_36);
	printf("The page 37 is %lx\n", (unsigned long)page_37);
	printf("The page 38 is %lx\n", (unsigned long)page_38);
	printf("The page 39 is %lx\n", (unsigned long)page_39);
	printf("The page 40 is %lx\n", (unsigned long)page_40);
	printf("The page 41 is %lx\n", (unsigned long)page_41);
	printf("The page 42 is %lx\n", (unsigned long)page_42);
	printf("The page 43 is %lx\n", (unsigned long)page_43);
	printf("The page 44 is %lx\n", (unsigned long)page_44);
	printf("The page 45 is %lx\n", (unsigned long)page_45);
	printf("The page 46 is %lx\n", (unsigned long)page_46);
	printf("The page 47 is %lx\n", (unsigned long)page_47);
	printf("The page 48 is %lx\n", (unsigned long)page_48);
	printf("The page 49 is %lx\n", (unsigned long)page_49);
	printf("The page 50 is %lx\n", (unsigned long)page_50);
	printf("The page 51 is %lx\n", (unsigned long)page_51);
	printf("The page 52 is %lx\n", (unsigned long)page_52);
	printf("The page 53 is %lx\n", (unsigned long)page_53);
	printf("The page 54 is %lx\n", (unsigned long)page_54);
	printf("The page 55 is %lx\n", (unsigned long)page_55);
	printf("The page 56 is %lx\n", (unsigned long)page_56);
	printf("The page 57 is %lx\n", (unsigned long)page_57);
	printf("The page 58 is %lx\n", (unsigned long)page_58);
	printf("The page 59 is %lx\n", (unsigned long)page_59);
	printf("The page 60 is %lx\n", (unsigned long)page_60);
	printf("The page 61 is %lx\n", (unsigned long)page_61);
	printf("The page 62 is %lx\n", (unsigned long)page_62);
	printf("The page 63 is %lx\n", (unsigned long)page_63);
	printf("The page 64 is %lx\n", (unsigned long)page_64);
	printf("The page 65 is %lx\n", (unsigned long)page_65);
	printf("The page 66 is %lx\n", (unsigned long)page_66);
	printf("The page 67 is %lx\n", (unsigned long)page_67);
	printf("The page 68 is %lx\n", (unsigned long)page_68);
	printf("The page 69 is %lx\n", (unsigned long)page_69);
	printf("The page 70 is %lx\n", (unsigned long)page_70);
	printf("The page 71 is %lx\n", (unsigned long)page_71);
	printf("The page 72 is %lx\n", (unsigned long)page_72);
	printf("The page 73 is %lx\n", (unsigned long)page_73);
	printf("The page 74 is %lx\n", (unsigned long)page_74);
	printf("The page 75 is %lx\n", (unsigned long)page_75);
	printf("The page 76 is %lx\n", (unsigned long)page_76);
	printf("The page 77 is %lx\n", (unsigned long)page_77);
	printf("The page 78 is %lx\n", (unsigned long)page_78);
	printf("The page 79 is %lx\n", (unsigned long)page_79);
	printf("The page 80 is %lx\n", (unsigned long)page_80);
	printf("The page 81 is %lx\n", (unsigned long)page_81);
	printf("The page 82 is %lx\n", (unsigned long)page_82);
	printf("The page 83 is %lx\n", (unsigned long)page_83);
	printf("The page 84 is %lx\n", (unsigned long)page_84);
	printf("The page 85 is %lx\n", (unsigned long)page_85);
	printf("The page 86 is %lx\n", (unsigned long)page_86);
	printf("The page 87 is %lx\n", (unsigned long)page_87);
	printf("The page 88 is %lx\n", (unsigned long)page_88);
	printf("The page 89 is %lx\n", (unsigned long)page_89);
	printf("The page 90 is %lx\n", (unsigned long)page_90);
	printf("The page 91 is %lx\n", (unsigned long)page_91);
	printf("The page 92 is %lx\n", (unsigned long)page_92);
	printf("The page 93 is %lx\n", (unsigned long)page_93);
	printf("The page 94 is %lx\n", (unsigned long)page_94);
	printf("The page 95 is %lx\n", (unsigned long)page_95);
	printf("The page 96 is %lx\n", (unsigned long)page_96);
	printf("The page 97 is %lx\n", (unsigned long)page_97);
	printf("The page 98 is %lx\n", (unsigned long)page_98);
	printf("The page 99 is %lx\n", (unsigned long)page_99);
	printf("The page 100 is %lx\n", (unsigned long)page_100);
	printf("The page 101 is %lx\n", (unsigned long)page_101);
	printf("The page 102 is %lx\n", (unsigned long)page_102);
	printf("The page 103 is %lx\n", (unsigned long)page_103);
	printf("The page 104 is %lx\n", (unsigned long)page_104);
	printf("The page 105 is %lx\n", (unsigned long)page_105);
	printf("The page 106 is %lx\n", (unsigned long)page_106);
	printf("The page 107 is %lx\n", (unsigned long)page_107);
	printf("The page 108 is %lx\n", (unsigned long)page_108);
	printf("The page 109 is %lx\n", (unsigned long)page_109);
	printf("The page 110 is %lx\n", (unsigned long)page_110);
	printf("The page 111 is %lx\n", (unsigned long)page_111);
	printf("The page 112 is %lx\n", (unsigned long)page_112);
	printf("The page 113 is %lx\n", (unsigned long)page_113);
	printf("The page 114 is %lx\n", (unsigned long)page_114);
	printf("The page 115 is %lx\n", (unsigned long)page_115);
	printf("The page 116 is %lx\n", (unsigned long)page_116);
	printf("The page 117 is %lx\n", (unsigned long)page_117);
	printf("The page 118 is %lx\n", (unsigned long)page_118);
	printf("The page 119 is %lx\n", (unsigned long)page_119);
	printf("The page 120 is %lx\n", (unsigned long)page_120);
	printf("The page 121 is %lx\n", (unsigned long)page_121);
	printf("The page 122 is %lx\n", (unsigned long)page_122);
	printf("The page 123 is %lx\n", (unsigned long)page_123);
	printf("The page 124 is %lx\n", (unsigned long)page_124);
	printf("The page 125 is %lx\n", (unsigned long)page_125);
	printf("The page 126 is %lx\n", (unsigned long)page_126);
	printf("The page 127 is %lx\n", (unsigned long)page_127);
	printf("The page 128 is %lx\n", (unsigned long)page_128);

    lz_enter(true);

    printf("Begin counting switch\n");

    start = 0;
retry1:
    for (i = 0; i < iter; i++) {
        page_1[16] = -page_1[16];
		page_2[16] = -page_2[16];
		page_3[16] = -page_3[16];
		page_4[16] = -page_4[16];
		page_5[16] = -page_5[16];
		page_6[16] = -page_6[16];
		page_7[16] = -page_7[16];
		page_8[16] = -page_8[16];
		page_9[16] = -page_9[16];
		page_10[16] = -page_10[16];
		page_11[16] = -page_11[16];
		page_12[16] = -page_12[16];
		page_13[16] = -page_13[16];
		page_14[16] = -page_14[16];
		page_15[16] = -page_15[16];
		page_16[16] = -page_16[16];
		page_17[16] = -page_17[16];
		page_18[16] = -page_18[16];
		page_19[16] = -page_19[16];
		page_20[16] = -page_20[16];
		page_21[16] = -page_21[16];
		page_22[16] = -page_22[16];
		page_23[16] = -page_23[16];
		page_24[16] = -page_24[16];
		page_25[16] = -page_25[16];
		page_26[16] = -page_26[16];
		page_27[16] = -page_27[16];
		page_28[16] = -page_28[16];
		page_29[16] = -page_29[16];
		page_30[16] = -page_30[16];
		page_31[16] = -page_31[16];
		page_32[16] = -page_32[16];
		page_33[16] = -page_33[16];
		page_34[16] = -page_34[16];
		page_35[16] = -page_35[16];
		page_36[16] = -page_36[16];
		page_37[16] = -page_37[16];
		page_38[16] = -page_38[16];
		page_39[16] = -page_39[16];
		page_40[16] = -page_40[16];
		page_41[16] = -page_41[16];
		page_42[16] = -page_42[16];
		page_43[16] = -page_43[16];
		page_44[16] = -page_44[16];
		page_45[16] = -page_45[16];
		page_46[16] = -page_46[16];
		page_47[16] = -page_47[16];
		page_48[16] = -page_48[16];
		page_49[16] = -page_49[16];
		page_50[16] = -page_50[16];
		page_51[16] = -page_51[16];
		page_52[16] = -page_52[16];
		page_53[16] = -page_53[16];
		page_54[16] = -page_54[16];
		page_55[16] = -page_55[16];
		page_56[16] = -page_56[16];
		page_57[16] = -page_57[16];
		page_58[16] = -page_58[16];
		page_59[16] = -page_59[16];
		page_60[16] = -page_60[16];
		page_61[16] = -page_61[16];
		page_62[16] = -page_62[16];
		page_63[16] = -page_63[16];
		page_64[16] = -page_64[16];
		page_65[16] = -page_65[16];
		page_66[16] = -page_66[16];
		page_67[16] = -page_67[16];
		page_68[16] = -page_68[16];
		page_69[16] = -page_69[16];
		page_70[16] = -page_70[16];
		page_71[16] = -page_71[16];
		page_72[16] = -page_72[16];
		page_73[16] = -page_73[16];
		page_74[16] = -page_74[16];
		page_75[16] = -page_75[16];
		page_76[16] = -page_76[16];
		page_77[16] = -page_77[16];
		page_78[16] = -page_78[16];
		page_79[16] = -page_79[16];
		page_80[16] = -page_80[16];
		page_81[16] = -page_81[16];
		page_82[16] = -page_82[16];
		page_83[16] = -page_83[16];
		page_84[16] = -page_84[16];
		page_85[16] = -page_85[16];
		page_86[16] = -page_86[16];
		page_87[16] = -page_87[16];
		page_88[16] = -page_88[16];
		page_89[16] = -page_89[16];
		page_90[16] = -page_90[16];
		page_91[16] = -page_91[16];
		page_92[16] = -page_92[16];
		page_93[16] = -page_93[16];
		page_94[16] = -page_94[16];
		page_95[16] = -page_95[16];
		page_96[16] = -page_96[16];
		page_97[16] = -page_97[16];
		page_98[16] = -page_98[16];
		page_99[16] = -page_99[16];
		page_100[16] = -page_100[16];
		page_101[16] = -page_101[16];
		page_102[16] = -page_102[16];
		page_103[16] = -page_103[16];
		page_104[16] = -page_104[16];
		page_105[16] = -page_105[16];
		page_106[16] = -page_106[16];
		page_107[16] = -page_107[16];
		page_108[16] = -page_108[16];
		page_109[16] = -page_109[16];
		page_110[16] = -page_110[16];
		page_111[16] = -page_111[16];
		page_112[16] = -page_112[16];
		page_113[16] = -page_113[16];
		page_114[16] = -page_114[16];
		page_115[16] = -page_115[16];
		page_116[16] = -page_116[16];
		page_117[16] = -page_117[16];
		page_118[16] = -page_118[16];
		page_119[16] = -page_119[16];
		page_120[16] = -page_120[16];
		page_121[16] = -page_121[16];
		page_122[16] = -page_122[16];
		page_123[16] = -page_123[16];
		page_124[16] = -page_124[16];
		page_125[16] = -page_125[16];
		page_126[16] = -page_126[16];
		page_127[16] = -page_127[16];
		page_128[16] = -page_128[16];
    }
	if (!start) {
		activate_counter();
		start = ccnt_read();
		goto retry1;
	}
    end = ccnt_read();

	printf("End counting switch, %ld cycles per switch, end is %ld, start is %ld, pmcr_el0 is %lx, pmcntenset_el0 is %lx, pmuserenr_el0 is %lx\n", 
            (baseline = (end - start) / NDOM / iter), end, start, pmcr_el0(), pmcntenset_el0(), pmuserenr_el0());

	int lz_1 = lz_alloc();
	lz_set_glz(lz_1, 0);
	int lz_2 = lz_alloc();
	lz_set_glz(lz_2, 1);
	int lz_3 = lz_alloc();
	lz_set_glz(lz_3, 2);
	int lz_4 = lz_alloc();
	lz_set_glz(lz_4, 3);
	int lz_5 = lz_alloc();
	lz_set_glz(lz_5, 4);
	int lz_6 = lz_alloc();
	lz_set_glz(lz_6, 5);
	int lz_7 = lz_alloc();
	lz_set_glz(lz_7, 6);
	int lz_8 = lz_alloc();
	lz_set_glz(lz_8, 7);
	int lz_9 = lz_alloc();
	lz_set_glz(lz_9, 8);
	int lz_10 = lz_alloc();
	lz_set_glz(lz_10, 9);
	int lz_11 = lz_alloc();
	lz_set_glz(lz_11, 10);
	int lz_12 = lz_alloc();
	lz_set_glz(lz_12, 11);
	int lz_13 = lz_alloc();
	lz_set_glz(lz_13, 12);
	int lz_14 = lz_alloc();
	lz_set_glz(lz_14, 13);
	int lz_15 = lz_alloc();
	lz_set_glz(lz_15, 14);
	int lz_16 = lz_alloc();
	lz_set_glz(lz_16, 15);
	int lz_17 = lz_alloc();
	lz_set_glz(lz_17, 16);
	int lz_18 = lz_alloc();
	lz_set_glz(lz_18, 17);
	int lz_19 = lz_alloc();
	lz_set_glz(lz_19, 18);
	int lz_20 = lz_alloc();
	lz_set_glz(lz_20, 19);
	int lz_21 = lz_alloc();
	lz_set_glz(lz_21, 20);
	int lz_22 = lz_alloc();
	lz_set_glz(lz_22, 21);
	int lz_23 = lz_alloc();
	lz_set_glz(lz_23, 22);
	int lz_24 = lz_alloc();
	lz_set_glz(lz_24, 23);
	int lz_25 = lz_alloc();
	lz_set_glz(lz_25, 24);
	int lz_26 = lz_alloc();
	lz_set_glz(lz_26, 25);
	int lz_27 = lz_alloc();
	lz_set_glz(lz_27, 26);
	int lz_28 = lz_alloc();
	lz_set_glz(lz_28, 27);
	int lz_29 = lz_alloc();
	lz_set_glz(lz_29, 28);
	int lz_30 = lz_alloc();
	lz_set_glz(lz_30, 29);
	int lz_31 = lz_alloc();
	lz_set_glz(lz_31, 30);
	int lz_32 = lz_alloc();
	lz_set_glz(lz_32, 31);
	int lz_33 = lz_alloc();
	lz_set_glz(lz_33, 32);
	int lz_34 = lz_alloc();
	lz_set_glz(lz_34, 33);
	int lz_35 = lz_alloc();
	lz_set_glz(lz_35, 34);
	int lz_36 = lz_alloc();
	lz_set_glz(lz_36, 35);
	int lz_37 = lz_alloc();
	lz_set_glz(lz_37, 36);
	int lz_38 = lz_alloc();
	lz_set_glz(lz_38, 37);
	int lz_39 = lz_alloc();
	lz_set_glz(lz_39, 38);
	int lz_40 = lz_alloc();
	lz_set_glz(lz_40, 39);
	int lz_41 = lz_alloc();
	lz_set_glz(lz_41, 40);
	int lz_42 = lz_alloc();
	lz_set_glz(lz_42, 41);
	int lz_43 = lz_alloc();
	lz_set_glz(lz_43, 42);
	int lz_44 = lz_alloc();
	lz_set_glz(lz_44, 43);
	int lz_45 = lz_alloc();
	lz_set_glz(lz_45, 44);
	int lz_46 = lz_alloc();
	lz_set_glz(lz_46, 45);
	int lz_47 = lz_alloc();
	lz_set_glz(lz_47, 46);
	int lz_48 = lz_alloc();
	lz_set_glz(lz_48, 47);
	int lz_49 = lz_alloc();
	lz_set_glz(lz_49, 48);
	int lz_50 = lz_alloc();
	lz_set_glz(lz_50, 49);
	int lz_51 = lz_alloc();
	lz_set_glz(lz_51, 50);
	int lz_52 = lz_alloc();
	lz_set_glz(lz_52, 51);
	int lz_53 = lz_alloc();
	lz_set_glz(lz_53, 52);
	int lz_54 = lz_alloc();
	lz_set_glz(lz_54, 53);
	int lz_55 = lz_alloc();
	lz_set_glz(lz_55, 54);
	int lz_56 = lz_alloc();
	lz_set_glz(lz_56, 55);
	int lz_57 = lz_alloc();
	lz_set_glz(lz_57, 56);
	int lz_58 = lz_alloc();
	lz_set_glz(lz_58, 57);
	int lz_59 = lz_alloc();
	lz_set_glz(lz_59, 58);
	int lz_60 = lz_alloc();
	lz_set_glz(lz_60, 59);
	int lz_61 = lz_alloc();
	lz_set_glz(lz_61, 60);
	int lz_62 = lz_alloc();
	lz_set_glz(lz_62, 61);
	int lz_63 = lz_alloc();
	lz_set_glz(lz_63, 62);
	int lz_64 = lz_alloc();
	lz_set_glz(lz_64, 63);
	int lz_65 = lz_alloc();
	lz_set_glz(lz_65, 64);
	int lz_66 = lz_alloc();
	lz_set_glz(lz_66, 65);
	int lz_67 = lz_alloc();
	lz_set_glz(lz_67, 66);
	int lz_68 = lz_alloc();
	lz_set_glz(lz_68, 67);
	int lz_69 = lz_alloc();
	lz_set_glz(lz_69, 68);
	int lz_70 = lz_alloc();
	lz_set_glz(lz_70, 69);
	int lz_71 = lz_alloc();
	lz_set_glz(lz_71, 70);
	int lz_72 = lz_alloc();
	lz_set_glz(lz_72, 71);
	int lz_73 = lz_alloc();
	lz_set_glz(lz_73, 72);
	int lz_74 = lz_alloc();
	lz_set_glz(lz_74, 73);
	int lz_75 = lz_alloc();
	lz_set_glz(lz_75, 74);
	int lz_76 = lz_alloc();
	lz_set_glz(lz_76, 75);
	int lz_77 = lz_alloc();
	lz_set_glz(lz_77, 76);
	int lz_78 = lz_alloc();
	lz_set_glz(lz_78, 77);
	int lz_79 = lz_alloc();
	lz_set_glz(lz_79, 78);
	int lz_80 = lz_alloc();
	lz_set_glz(lz_80, 79);
	int lz_81 = lz_alloc();
	lz_set_glz(lz_81, 80);
	int lz_82 = lz_alloc();
	lz_set_glz(lz_82, 81);
	int lz_83 = lz_alloc();
	lz_set_glz(lz_83, 82);
	int lz_84 = lz_alloc();
	lz_set_glz(lz_84, 83);
	int lz_85 = lz_alloc();
	lz_set_glz(lz_85, 84);
	int lz_86 = lz_alloc();
	lz_set_glz(lz_86, 85);
	int lz_87 = lz_alloc();
	lz_set_glz(lz_87, 86);
	int lz_88 = lz_alloc();
	lz_set_glz(lz_88, 87);
	int lz_89 = lz_alloc();
	lz_set_glz(lz_89, 88);
	int lz_90 = lz_alloc();
	lz_set_glz(lz_90, 89);
	int lz_91 = lz_alloc();
	lz_set_glz(lz_91, 90);
	int lz_92 = lz_alloc();
	lz_set_glz(lz_92, 91);
	int lz_93 = lz_alloc();
	lz_set_glz(lz_93, 92);
	int lz_94 = lz_alloc();
	lz_set_glz(lz_94, 93);
	int lz_95 = lz_alloc();
	lz_set_glz(lz_95, 94);
	int lz_96 = lz_alloc();
	lz_set_glz(lz_96, 95);
	int lz_97 = lz_alloc();
	lz_set_glz(lz_97, 96);
	int lz_98 = lz_alloc();
	lz_set_glz(lz_98, 97);
	int lz_99 = lz_alloc();
	lz_set_glz(lz_99, 98);
	int lz_100 = lz_alloc();
	lz_set_glz(lz_100, 99);
	int lz_101 = lz_alloc();
	lz_set_glz(lz_101, 100);
	int lz_102 = lz_alloc();
	lz_set_glz(lz_102, 101);
	int lz_103 = lz_alloc();
	lz_set_glz(lz_103, 102);
	int lz_104 = lz_alloc();
	lz_set_glz(lz_104, 103);
	int lz_105 = lz_alloc();
	lz_set_glz(lz_105, 104);
	int lz_106 = lz_alloc();
	lz_set_glz(lz_106, 105);
	int lz_107 = lz_alloc();
	lz_set_glz(lz_107, 106);
	int lz_108 = lz_alloc();
	lz_set_glz(lz_108, 107);
	int lz_109 = lz_alloc();
	lz_set_glz(lz_109, 108);
	int lz_110 = lz_alloc();
	lz_set_glz(lz_110, 109);
	int lz_111 = lz_alloc();
	lz_set_glz(lz_111, 110);
	int lz_112 = lz_alloc();
	lz_set_glz(lz_112, 111);
	int lz_113 = lz_alloc();
	lz_set_glz(lz_113, 112);
	int lz_114 = lz_alloc();
	lz_set_glz(lz_114, 113);
	int lz_115 = lz_alloc();
	lz_set_glz(lz_115, 114);
	int lz_116 = lz_alloc();
	lz_set_glz(lz_116, 115);
	int lz_117 = lz_alloc();
	lz_set_glz(lz_117, 116);
	int lz_118 = lz_alloc();
	lz_set_glz(lz_118, 117);
	int lz_119 = lz_alloc();
	lz_set_glz(lz_119, 118);
	int lz_120 = lz_alloc();
	lz_set_glz(lz_120, 119);
	int lz_121 = lz_alloc();
	lz_set_glz(lz_121, 120);
	int lz_122 = lz_alloc();
	lz_set_glz(lz_122, 121);
	int lz_123 = lz_alloc();
	lz_set_glz(lz_123, 122);
	int lz_124 = lz_alloc();
	lz_set_glz(lz_124, 123);
	int lz_125 = lz_alloc();
	lz_set_glz(lz_125, 124);
	int lz_126 = lz_alloc();
	lz_set_glz(lz_126, 125);
	int lz_127 = lz_alloc();
	lz_set_glz(lz_127, 126);
	int lz_128 = lz_alloc();
	lz_set_glz(lz_128, 127);

	lz_mprotect((unsigned long)page_1, PAGE_SIZE, lz_1, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_2, PAGE_SIZE, lz_2, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_3, PAGE_SIZE, lz_3, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_4, PAGE_SIZE, lz_4, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_5, PAGE_SIZE, lz_5, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_6, PAGE_SIZE, lz_6, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_7, PAGE_SIZE, lz_7, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_8, PAGE_SIZE, lz_8, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_9, PAGE_SIZE, lz_9, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_10, PAGE_SIZE, lz_10, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_11, PAGE_SIZE, lz_11, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_12, PAGE_SIZE, lz_12, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_13, PAGE_SIZE, lz_13, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_14, PAGE_SIZE, lz_14, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_15, PAGE_SIZE, lz_15, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_16, PAGE_SIZE, lz_16, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_17, PAGE_SIZE, lz_17, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_18, PAGE_SIZE, lz_18, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_19, PAGE_SIZE, lz_19, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_20, PAGE_SIZE, lz_20, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_21, PAGE_SIZE, lz_21, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_22, PAGE_SIZE, lz_22, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_23, PAGE_SIZE, lz_23, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_24, PAGE_SIZE, lz_24, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_25, PAGE_SIZE, lz_25, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_26, PAGE_SIZE, lz_26, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_27, PAGE_SIZE, lz_27, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_28, PAGE_SIZE, lz_28, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_29, PAGE_SIZE, lz_29, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_30, PAGE_SIZE, lz_30, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_31, PAGE_SIZE, lz_31, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_32, PAGE_SIZE, lz_32, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_33, PAGE_SIZE, lz_33, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_34, PAGE_SIZE, lz_34, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_35, PAGE_SIZE, lz_35, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_36, PAGE_SIZE, lz_36, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_37, PAGE_SIZE, lz_37, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_38, PAGE_SIZE, lz_38, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_39, PAGE_SIZE, lz_39, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_40, PAGE_SIZE, lz_40, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_41, PAGE_SIZE, lz_41, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_42, PAGE_SIZE, lz_42, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_43, PAGE_SIZE, lz_43, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_44, PAGE_SIZE, lz_44, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_45, PAGE_SIZE, lz_45, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_46, PAGE_SIZE, lz_46, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_47, PAGE_SIZE, lz_47, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_48, PAGE_SIZE, lz_48, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_49, PAGE_SIZE, lz_49, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_50, PAGE_SIZE, lz_50, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_51, PAGE_SIZE, lz_51, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_52, PAGE_SIZE, lz_52, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_53, PAGE_SIZE, lz_53, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_54, PAGE_SIZE, lz_54, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_55, PAGE_SIZE, lz_55, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_56, PAGE_SIZE, lz_56, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_57, PAGE_SIZE, lz_57, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_58, PAGE_SIZE, lz_58, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_59, PAGE_SIZE, lz_59, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_60, PAGE_SIZE, lz_60, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_61, PAGE_SIZE, lz_61, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_62, PAGE_SIZE, lz_62, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_63, PAGE_SIZE, lz_63, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_64, PAGE_SIZE, lz_64, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_65, PAGE_SIZE, lz_65, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_66, PAGE_SIZE, lz_66, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_67, PAGE_SIZE, lz_67, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_68, PAGE_SIZE, lz_68, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_69, PAGE_SIZE, lz_69, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_70, PAGE_SIZE, lz_70, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_71, PAGE_SIZE, lz_71, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_72, PAGE_SIZE, lz_72, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_73, PAGE_SIZE, lz_73, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_74, PAGE_SIZE, lz_74, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_75, PAGE_SIZE, lz_75, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_76, PAGE_SIZE, lz_76, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_77, PAGE_SIZE, lz_77, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_78, PAGE_SIZE, lz_78, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_79, PAGE_SIZE, lz_79, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_80, PAGE_SIZE, lz_80, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_81, PAGE_SIZE, lz_81, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_82, PAGE_SIZE, lz_82, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_83, PAGE_SIZE, lz_83, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_84, PAGE_SIZE, lz_84, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_85, PAGE_SIZE, lz_85, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_86, PAGE_SIZE, lz_86, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_87, PAGE_SIZE, lz_87, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_88, PAGE_SIZE, lz_88, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_89, PAGE_SIZE, lz_89, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_90, PAGE_SIZE, lz_90, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_91, PAGE_SIZE, lz_91, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_92, PAGE_SIZE, lz_92, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_93, PAGE_SIZE, lz_93, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_94, PAGE_SIZE, lz_94, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_95, PAGE_SIZE, lz_95, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_96, PAGE_SIZE, lz_96, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_97, PAGE_SIZE, lz_97, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_98, PAGE_SIZE, lz_98, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_99, PAGE_SIZE, lz_99, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_100, PAGE_SIZE, lz_100, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_101, PAGE_SIZE, lz_101, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_102, PAGE_SIZE, lz_102, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_103, PAGE_SIZE, lz_103, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_104, PAGE_SIZE, lz_104, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_105, PAGE_SIZE, lz_105, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_106, PAGE_SIZE, lz_106, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_107, PAGE_SIZE, lz_107, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_108, PAGE_SIZE, lz_108, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_109, PAGE_SIZE, lz_109, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_110, PAGE_SIZE, lz_110, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_111, PAGE_SIZE, lz_111, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_112, PAGE_SIZE, lz_112, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_113, PAGE_SIZE, lz_113, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_114, PAGE_SIZE, lz_114, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_115, PAGE_SIZE, lz_115, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_116, PAGE_SIZE, lz_116, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_117, PAGE_SIZE, lz_117, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_118, PAGE_SIZE, lz_118, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_119, PAGE_SIZE, lz_119, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_120, PAGE_SIZE, lz_120, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_121, PAGE_SIZE, lz_121, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_122, PAGE_SIZE, lz_122, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_123, PAGE_SIZE, lz_123, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_124, PAGE_SIZE, lz_124, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_125, PAGE_SIZE, lz_125, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_126, PAGE_SIZE, lz_126, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_127, PAGE_SIZE, lz_127, LZ_PROT_READ | LZ_PROT_WRITE);
	lz_mprotect((unsigned long)page_128, PAGE_SIZE, lz_128, LZ_PROT_READ | LZ_PROT_WRITE);

	printf("Finished lz_mprotect\n");
	sleep(1);

	printf("Begin counting switch\n");

    start = 0;
retry2:
    for (i = 0; i < iter; i++) {
        lz_switch_to_gate(0);
		page_1[16] = -page_1[16];
		lz_switch_to_gate(1);
		page_2[16] = -page_2[16];
		lz_switch_to_gate(2);
		page_3[16] = -page_3[16];
		lz_switch_to_gate(3);
		page_4[16] = -page_4[16];
		lz_switch_to_gate(4);
		page_5[16] = -page_5[16];
		lz_switch_to_gate(5);
		page_6[16] = -page_6[16];
		lz_switch_to_gate(6);
		page_7[16] = -page_7[16];
		lz_switch_to_gate(7);
		page_8[16] = -page_8[16];
		lz_switch_to_gate(8);
		page_9[16] = -page_9[16];
		lz_switch_to_gate(9);
		page_10[16] = -page_10[16];
		lz_switch_to_gate(10);
		page_11[16] = -page_11[16];
		lz_switch_to_gate(11);
		page_12[16] = -page_12[16];
		lz_switch_to_gate(12);
		page_13[16] = -page_13[16];
		lz_switch_to_gate(13);
		page_14[16] = -page_14[16];
		lz_switch_to_gate(14);
		page_15[16] = -page_15[16];
		lz_switch_to_gate(15);
		page_16[16] = -page_16[16];
		lz_switch_to_gate(16);
		page_17[16] = -page_17[16];
		lz_switch_to_gate(17);
		page_18[16] = -page_18[16];
		lz_switch_to_gate(18);
		page_19[16] = -page_19[16];
		lz_switch_to_gate(19);
		page_20[16] = -page_20[16];
		lz_switch_to_gate(20);
		page_21[16] = -page_21[16];
		lz_switch_to_gate(21);
		page_22[16] = -page_22[16];
		lz_switch_to_gate(22);
		page_23[16] = -page_23[16];
		lz_switch_to_gate(23);
		page_24[16] = -page_24[16];
		lz_switch_to_gate(24);
		page_25[16] = -page_25[16];
		lz_switch_to_gate(25);
		page_26[16] = -page_26[16];
		lz_switch_to_gate(26);
		page_27[16] = -page_27[16];
		lz_switch_to_gate(27);
		page_28[16] = -page_28[16];
		lz_switch_to_gate(28);
		page_29[16] = -page_29[16];
		lz_switch_to_gate(29);
		page_30[16] = -page_30[16];
		lz_switch_to_gate(30);
		page_31[16] = -page_31[16];
		lz_switch_to_gate(31);
		page_32[16] = -page_32[16];
		lz_switch_to_gate(32);
		page_33[16] = -page_33[16];
		lz_switch_to_gate(33);
		page_34[16] = -page_34[16];
		lz_switch_to_gate(34);
		page_35[16] = -page_35[16];
		lz_switch_to_gate(35);
		page_36[16] = -page_36[16];
		lz_switch_to_gate(36);
		page_37[16] = -page_37[16];
		lz_switch_to_gate(37);
		page_38[16] = -page_38[16];
		lz_switch_to_gate(38);
		page_39[16] = -page_39[16];
		lz_switch_to_gate(39);
		page_40[16] = -page_40[16];
		lz_switch_to_gate(40);
		page_41[16] = -page_41[16];
		lz_switch_to_gate(41);
		page_42[16] = -page_42[16];
		lz_switch_to_gate(42);
		page_43[16] = -page_43[16];
		lz_switch_to_gate(43);
		page_44[16] = -page_44[16];
		lz_switch_to_gate(44);
		page_45[16] = -page_45[16];
		lz_switch_to_gate(45);
		page_46[16] = -page_46[16];
		lz_switch_to_gate(46);
		page_47[16] = -page_47[16];
		lz_switch_to_gate(47);
		page_48[16] = -page_48[16];
		lz_switch_to_gate(48);
		page_49[16] = -page_49[16];
		lz_switch_to_gate(49);
		page_50[16] = -page_50[16];
		lz_switch_to_gate(50);
		page_51[16] = -page_51[16];
		lz_switch_to_gate(51);
		page_52[16] = -page_52[16];
		lz_switch_to_gate(52);
		page_53[16] = -page_53[16];
		lz_switch_to_gate(53);
		page_54[16] = -page_54[16];
		lz_switch_to_gate(54);
		page_55[16] = -page_55[16];
		lz_switch_to_gate(55);
		page_56[16] = -page_56[16];
		lz_switch_to_gate(56);
		page_57[16] = -page_57[16];
		lz_switch_to_gate(57);
		page_58[16] = -page_58[16];
		lz_switch_to_gate(58);
		page_59[16] = -page_59[16];
		lz_switch_to_gate(59);
		page_60[16] = -page_60[16];
		lz_switch_to_gate(60);
		page_61[16] = -page_61[16];
		lz_switch_to_gate(61);
		page_62[16] = -page_62[16];
		lz_switch_to_gate(62);
		page_63[16] = -page_63[16];
		lz_switch_to_gate(63);
		page_64[16] = -page_64[16];
		lz_switch_to_gate(64);
		page_65[16] = -page_65[16];
		lz_switch_to_gate(65);
		page_66[16] = -page_66[16];
		lz_switch_to_gate(66);
		page_67[16] = -page_67[16];
		lz_switch_to_gate(67);
		page_68[16] = -page_68[16];
		lz_switch_to_gate(68);
		page_69[16] = -page_69[16];
		lz_switch_to_gate(69);
		page_70[16] = -page_70[16];
		lz_switch_to_gate(70);
		page_71[16] = -page_71[16];
		lz_switch_to_gate(71);
		page_72[16] = -page_72[16];
		lz_switch_to_gate(72);
		page_73[16] = -page_73[16];
		lz_switch_to_gate(73);
		page_74[16] = -page_74[16];
		lz_switch_to_gate(74);
		page_75[16] = -page_75[16];
		lz_switch_to_gate(75);
		page_76[16] = -page_76[16];
		lz_switch_to_gate(76);
		page_77[16] = -page_77[16];
		lz_switch_to_gate(77);
		page_78[16] = -page_78[16];
		lz_switch_to_gate(78);
		page_79[16] = -page_79[16];
		lz_switch_to_gate(79);
		page_80[16] = -page_80[16];
		lz_switch_to_gate(80);
		page_81[16] = -page_81[16];
		lz_switch_to_gate(81);
		page_82[16] = -page_82[16];
		lz_switch_to_gate(82);
		page_83[16] = -page_83[16];
		lz_switch_to_gate(83);
		page_84[16] = -page_84[16];
		lz_switch_to_gate(84);
		page_85[16] = -page_85[16];
		lz_switch_to_gate(85);
		page_86[16] = -page_86[16];
		lz_switch_to_gate(86);
		page_87[16] = -page_87[16];
		lz_switch_to_gate(87);
		page_88[16] = -page_88[16];
		lz_switch_to_gate(88);
		page_89[16] = -page_89[16];
		lz_switch_to_gate(89);
		page_90[16] = -page_90[16];
		lz_switch_to_gate(90);
		page_91[16] = -page_91[16];
		lz_switch_to_gate(91);
		page_92[16] = -page_92[16];
		lz_switch_to_gate(92);
		page_93[16] = -page_93[16];
		lz_switch_to_gate(93);
		page_94[16] = -page_94[16];
		lz_switch_to_gate(94);
		page_95[16] = -page_95[16];
		lz_switch_to_gate(95);
		page_96[16] = -page_96[16];
		lz_switch_to_gate(96);
		page_97[16] = -page_97[16];
		lz_switch_to_gate(97);
		page_98[16] = -page_98[16];
		lz_switch_to_gate(98);
		page_99[16] = -page_99[16];
		lz_switch_to_gate(99);
		page_100[16] = -page_100[16];
		lz_switch_to_gate(100);
		page_101[16] = -page_101[16];
		lz_switch_to_gate(101);
		page_102[16] = -page_102[16];
		lz_switch_to_gate(102);
		page_103[16] = -page_103[16];
		lz_switch_to_gate(103);
		page_104[16] = -page_104[16];
		lz_switch_to_gate(104);
		page_105[16] = -page_105[16];
		lz_switch_to_gate(105);
		page_106[16] = -page_106[16];
		lz_switch_to_gate(106);
		page_107[16] = -page_107[16];
		lz_switch_to_gate(107);
		page_108[16] = -page_108[16];
		lz_switch_to_gate(108);
		page_109[16] = -page_109[16];
		lz_switch_to_gate(109);
		page_110[16] = -page_110[16];
		lz_switch_to_gate(110);
		page_111[16] = -page_111[16];
		lz_switch_to_gate(111);
		page_112[16] = -page_112[16];
		lz_switch_to_gate(112);
		page_113[16] = -page_113[16];
		lz_switch_to_gate(113);
		page_114[16] = -page_114[16];
		lz_switch_to_gate(114);
		page_115[16] = -page_115[16];
		lz_switch_to_gate(115);
		page_116[16] = -page_116[16];
		lz_switch_to_gate(116);
		page_117[16] = -page_117[16];
		lz_switch_to_gate(117);
		page_118[16] = -page_118[16];
		lz_switch_to_gate(118);
		page_119[16] = -page_119[16];
		lz_switch_to_gate(119);
		page_120[16] = -page_120[16];
		lz_switch_to_gate(120);
		page_121[16] = -page_121[16];
		lz_switch_to_gate(121);
		page_122[16] = -page_122[16];
		lz_switch_to_gate(122);
		page_123[16] = -page_123[16];
		lz_switch_to_gate(123);
		page_124[16] = -page_124[16];
		lz_switch_to_gate(124);
		page_125[16] = -page_125[16];
		lz_switch_to_gate(125);
		page_126[16] = -page_126[16];
		lz_switch_to_gate(126);
		page_127[16] = -page_127[16];
		lz_switch_to_gate(127);
		page_128[16] = -page_128[16];
    }
	if (!start) {
		activate_counter();
		start = ccnt_read();
		goto retry2;
	}
    end = ccnt_read();

    printf("End counting switch, %ld cycles per switch, end is %ld, start is %ld, pmcr_el0 is %lx, pmcntenset_el0 is %lx, pmuserenr_el0 is %lx\n", 
            (end - start) / NDOM / iter - baseline, end, start, pmcr_el0(), pmcntenset_el0(), pmuserenr_el0());

	return 0;
}